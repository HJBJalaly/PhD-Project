function Dx=RabitDynamic(t,x,L_fem, L_tib, L_torso, Lc_fem, Lc_tib, Lc_torso, M_fem, M_tib, M_torso, XX_fem, XX_tib, XX_torso, g, Alfa,Theta_plus,Theta_minus,Kp,Kd)

q1=x(1);
q2=x(2);
q3=x(3);
q4=x(4);
q5=x(5);

dq1=x(6);
dq2=x(7);
dq3=x(8);
dq4=x(9);
dq5=x(10);

%% Dynamic
GG = [ g*(2*L_tib*M_fem*sin(q1 + q3 + q5) + 2*L_tib*M_tib*sin(q1 + q3 + q5) + L_tib*M_torso*sin(q1 + q3 + q5) - Lc_tib*M_tib*sin(q1 + q3 + q5) + 2*L_fem*M_fem*sin(q1 + q5) + L_fem*M_tib*sin(q1 + q5) + L_fem*M_torso*sin(q1 + q5) - Lc_fem*M_fem*sin(q1 + q5));
      -g*(M_tib*(L_fem*sin(q2 + q5) + Lc_tib*sin(q2 + q4 + q5)) + Lc_fem*M_fem*sin(q2 + q5));
       g*sin(q1 + q3 + q5)*(2*L_tib*M_fem + 2*L_tib*M_tib + L_tib*M_torso - Lc_tib*M_tib);
      -Lc_tib*M_tib*g*sin(q2 + q4 + q5);
       g*(2*L_tib*M_fem*sin(q1 + q3 + q5) + 2*L_tib*M_tib*sin(q1 + q3 + q5) + L_tib*M_torso*sin(q1 + q3 + q5) - Lc_tib*M_tib*sin(q1 + q3 + q5) - Lc_tib*M_tib*sin(q2 + q4 + q5) + 2*L_fem*M_fem*sin(q1 + q5) + L_fem*M_tib*sin(q1 + q5) - L_fem*M_tib*sin(q2 + q5) + L_fem*M_torso*sin(q1 + q5) - Lc_fem*M_fem*sin(q1 + q5) - Lc_fem*M_fem*sin(q2 + q5) - L_torso*M_torso*sin(q5) + Lc_torso*M_torso*sin(q5))];
 
DD = [ XX_fem + XX_tib + 2*L_fem^2*M_fem + L_fem^2*M_tib + 2*L_tib^2*M_fem + L_fem^2*M_torso + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_fem^2*M_fem + Lc_tib^2*M_tib - 2*L_fem*Lc_fem*M_fem - 2*L_tib*Lc_tib*M_tib + 4*L_fem*L_tib*M_fem*cos(q3) + 2*L_fem*L_tib*M_tib*cos(q3) + 2*L_fem*L_tib*M_torso*cos(q3) - 2*L_tib*Lc_fem*M_fem*cos(q3),                                                                                                  - L_fem^2*M_tib*cos(q1 - q2) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3),                                                                                                                                                                                                     XX_tib + 2*L_tib^2*M_fem + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_tib^2*M_tib - 2*L_tib*Lc_tib*M_tib + 2*L_fem*L_tib*M_fem*cos(q3) + L_fem*L_tib*M_tib*cos(q3) + L_fem*L_tib*M_torso*cos(q3) - L_tib*Lc_fem*M_fem*cos(q3),                                                      - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4),                                                                                                                                               XX_fem + XX_tib + 2*L_fem^2*M_fem + L_fem^2*M_tib + 2*L_tib^2*M_fem + L_fem^2*M_torso + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_fem^2*M_fem + Lc_tib^2*M_tib - 2*L_fem*Lc_fem*M_fem - 2*L_tib*Lc_tib*M_tib - L_fem^2*M_tib*cos(q1 - q2) + 4*L_fem*L_tib*M_fem*cos(q3) + 2*L_fem*L_tib*M_tib*cos(q3) + 2*L_fem*L_tib*M_torso*cos(q3) - L_fem*L_torso*M_torso*cos(q1) - 2*L_tib*Lc_fem*M_fem*cos(q3) + L_fem*Lc_torso*M_torso*cos(q1) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3) - L_tib*L_torso*M_torso*cos(q1 + q3) + L_tib*Lc_torso*M_torso*cos(q1 + q3);
      -L_fem^2*M_tib*cos(q1 - q2) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3),                                                                                                                                                                                                                                M_tib*L_fem^2 + 2*M_tib*cos(q4)*L_fem*Lc_tib + M_fem*Lc_fem^2 + M_tib*Lc_tib^2 + XX_fem + XX_tib,                                                                                                                                                                                                                                                                                                      - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3),                                                                                    M_tib*Lc_tib^2 + L_fem*M_tib*cos(q4)*Lc_tib + XX_tib,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               XX_fem + XX_tib + L_fem^2*M_tib + Lc_fem^2*M_fem + Lc_tib^2*M_tib - L_fem^2*M_tib*cos(q1 - q2) + 2*L_fem*Lc_tib*M_tib*cos(q4) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3);
       XX_tib + 2*L_tib^2*M_fem + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_tib^2*M_tib - 2*L_tib*Lc_tib*M_tib + 2*L_fem*L_tib*M_fem*cos(q3) + L_fem*L_tib*M_tib*cos(q3) + L_fem*L_tib*M_torso*cos(q3) - L_tib*Lc_fem*M_fem*cos(q3),                                                                                                                                                                                                        - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3),                                                                                                                                                                                                                                                                                                                          XX_tib + 2*L_tib^2*M_fem + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_tib^2*M_tib - 2*L_tib*Lc_tib*M_tib,                                                                                              -L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4),                                                                                                                                                                                                                                                                                                                                                                                                                                 XX_tib + 2*L_tib^2*M_fem + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_tib^2*M_tib - 2*L_tib*Lc_tib*M_tib + 2*L_fem*L_tib*M_fem*cos(q3) + L_fem*L_tib*M_tib*cos(q3) + L_fem*L_tib*M_torso*cos(q3) - L_tib*Lc_fem*M_fem*cos(q3) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3) - L_tib*L_torso*M_torso*cos(q1 + q3) + L_tib*Lc_torso*M_torso*cos(q1 + q3);
      -L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4),                                                                                                                                                                                                                                                                            M_tib*Lc_tib^2 + L_fem*M_tib*cos(q4)*Lc_tib + XX_tib,                                                                                                                                                                                                                                                                                                                                                                                    -L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4),                                                                                                                 M_tib*Lc_tib^2 + XX_tib,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       XX_tib + Lc_tib^2*M_tib + L_fem*Lc_tib*M_tib*cos(q4) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4);
       XX_fem + XX_tib + 2*L_fem^2*M_fem + L_fem^2*M_tib + 2*L_tib^2*M_fem + L_fem^2*M_torso + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_fem^2*M_fem + Lc_tib^2*M_tib - 2*L_fem*Lc_fem*M_fem - 2*L_tib*Lc_tib*M_tib - L_fem^2*M_tib*cos(q1 - q2) + 4*L_fem*L_tib*M_fem*cos(q3) + 2*L_fem*L_tib*M_tib*cos(q3) + 2*L_fem*L_tib*M_torso*cos(q3) - L_fem*L_torso*M_torso*cos(q1) - 2*L_tib*Lc_fem*M_fem*cos(q3) + L_fem*Lc_torso*M_torso*cos(q1) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3) - L_tib*L_torso*M_torso*cos(q1 + q3) + L_tib*Lc_torso*M_torso*cos(q1 + q3), XX_fem + XX_tib + L_fem^2*M_tib + Lc_fem^2*M_fem + Lc_tib^2*M_tib - L_fem^2*M_tib*cos(q1 - q2) + 2*L_fem*Lc_tib*M_tib*cos(q4) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*cos(q1 - q2) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3), XX_tib + 2*L_tib^2*M_fem + 2*L_tib^2*M_tib + L_tib^2*M_torso + Lc_tib^2*M_tib - 2*L_tib*Lc_tib*M_tib + 2*L_fem*L_tib*M_fem*cos(q3) + L_fem*L_tib*M_tib*cos(q3) + L_fem*L_tib*M_torso*cos(q3) - L_tib*Lc_fem*M_fem*cos(q3) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3) - L_tib*L_torso*M_torso*cos(q1 + q3) + L_tib*Lc_torso*M_torso*cos(q1 + q3), XX_tib + Lc_tib^2*M_tib + L_fem*Lc_tib*M_tib*cos(q4) - L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4), 2*XX_fem + 2*XX_tib + XX_torso + 2*L_fem^2*M_fem + 2*L_fem^2*M_tib + 2*L_tib^2*M_fem + L_fem^2*M_torso + 2*L_tib^2*M_tib + L_tib^2*M_torso + L_torso^2*M_torso + 2*Lc_fem^2*M_fem + 2*Lc_tib^2*M_tib + Lc_torso^2*M_torso - 2*L_fem*Lc_fem*M_fem - 2*L_tib*Lc_tib*M_tib - 2*L_torso*Lc_torso*M_torso - 2*L_fem^2*M_tib*cos(q1 - q2) + 4*L_fem*L_tib*M_fem*cos(q3) + 2*L_fem*L_tib*M_tib*cos(q3) + 2*L_fem*L_tib*M_torso*cos(q3) - 2*L_fem*L_torso*M_torso*cos(q1) - 2*L_tib*Lc_fem*M_fem*cos(q3) + 2*L_fem*Lc_tib*M_tib*cos(q4) + 2*L_fem*Lc_torso*M_torso*cos(q1) - 2*L_fem*Lc_tib*M_tib*cos(q1 - q2 - q4) - 2*L_fem*Lc_fem*M_fem*cos(q1 - q2) - 2*L_tib*Lc_tib*M_tib*cos(q1 - q2 + q3 - q4) - 2*L_fem*L_tib*M_tib*cos(q1 - q2 + q3) - 2*L_tib*Lc_fem*M_fem*cos(q1 - q2 + q3) - 2*L_tib*L_torso*M_torso*cos(q1 + q3) + 2*L_tib*Lc_torso*M_torso*cos(q1 + q3)];
 
 
CC = [-L_tib*dq3*sin(q3)*(2*L_fem*M_fem + L_fem*M_tib + L_fem*M_torso - Lc_fem*M_fem),                 - dq2*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) - dq5*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) - Lc_tib*M_tib*dq4*(L_tib*sin(q1 - q2 + q3 - q4) + L_fem*sin(q1 - q2 - q4)),                                                                                                                                                                                              -L_tib*sin(q3)*(dq1 + dq3 + dq5)*(2*L_fem*M_fem + L_fem*M_tib + L_fem*M_torso - Lc_fem*M_fem),                 -Lc_tib*M_tib*(L_tib*sin(q1 - q2 + q3 - q4) + L_fem*sin(q1 - q2 - q4))*(dq2 + dq4 + dq5),                                                                                                                                                                                                                                                          L_tib*Lc_torso*M_torso*dq5*sin(q1 + q3) - L_fem^2*M_tib*dq5*sin(q1 - q2) - L_fem*L_tib*M_tib*dq2*sin(q1 - q2 + q3) - L_fem*L_tib*M_tib*dq5*sin(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*dq2*sin(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*dq5*sin(q1 - q2 + q3) - L_tib*L_torso*M_torso*dq5*sin(q1 + q3) - L_fem^2*M_tib*dq2*sin(q1 - q2) - 2*L_fem*L_tib*M_fem*dq3*sin(q3) - L_fem*L_tib*M_tib*dq3*sin(q3) - L_fem*L_tib*M_torso*dq3*sin(q3) - L_fem*L_torso*M_torso*dq5*sin(q1) + L_tib*Lc_fem*M_fem*dq3*sin(q3) + L_fem*Lc_torso*M_torso*dq5*sin(q1) - L_fem*Lc_tib*M_tib*dq2*sin(q1 - q2 - q4) - L_fem*Lc_tib*M_tib*dq4*sin(q1 - q2 - q4) - L_fem*Lc_tib*M_tib*dq5*sin(q1 - q2 - q4) - L_fem*Lc_fem*M_fem*dq2*sin(q1 - q2) - L_fem*Lc_fem*M_fem*dq5*sin(q1 - q2) - L_tib*Lc_tib*M_tib*dq2*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq4*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq5*sin(q1 - q2 + q3 - q4);
       dq1*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) + dq5*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) + L_tib*dq3*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -L_fem*Lc_tib*M_tib*dq4*sin(q4),                                                                                                                                                             L_tib*(dq1 + dq3 + dq5)*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3)),                                                            -L_fem*Lc_tib*M_tib*sin(q4)*(dq2 + dq4 + dq5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                L_fem^2*M_tib*dq1*sin(q1 - q2) + L_fem^2*M_tib*dq5*sin(q1 - q2) + L_fem*L_tib*M_tib*dq1*sin(q1 - q2 + q3) + L_fem*L_tib*M_tib*dq3*sin(q1 - q2 + q3) + L_fem*L_tib*M_tib*dq5*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*dq1*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*dq3*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*dq5*sin(q1 - q2 + q3) - L_fem*Lc_tib*M_tib*dq4*sin(q4) + L_fem*Lc_tib*M_tib*dq1*sin(q1 - q2 - q4) + L_fem*Lc_tib*M_tib*dq5*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*dq1*sin(q1 - q2) + L_fem*Lc_fem*M_fem*dq5*sin(q1 - q2) + L_tib*Lc_tib*M_tib*dq1*sin(q1 - q2 + q3 - q4) + L_tib*Lc_tib*M_tib*dq3*sin(q1 - q2 + q3 - q4) + L_tib*Lc_tib*M_tib*dq5*sin(q1 - q2 + q3 - q4);
       L_tib*sin(q3)*(dq1 + dq5)*(2*L_fem*M_fem + L_fem*M_tib + L_fem*M_torso - Lc_fem*M_fem),                                                                                                                                                                                                                                                                                 - L_tib*dq2*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3)) - L_tib*dq5*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3)) - L_tib*Lc_tib*M_tib*dq4*sin(q1 - q2 + q3 - q4),                                                                                                                                                                                                                                                                                          0,                                             -L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4)*(dq2 + dq4 + dq5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                             L_tib*Lc_torso*M_torso*dq5*sin(q1 + q3) - L_fem*L_tib*M_tib*dq5*sin(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*dq2*sin(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*dq5*sin(q1 - q2 + q3) - L_tib*L_torso*M_torso*dq5*sin(q1 + q3) - L_fem*L_tib*M_tib*dq2*sin(q1 - q2 + q3) + 2*L_fem*L_tib*M_fem*dq1*sin(q3) + 2*L_fem*L_tib*M_fem*dq5*sin(q3) + L_fem*L_tib*M_tib*dq1*sin(q3) + L_fem*L_tib*M_tib*dq5*sin(q3) + L_fem*L_tib*M_torso*dq1*sin(q3) + L_fem*L_tib*M_torso*dq5*sin(q3) - L_tib*Lc_fem*M_fem*dq1*sin(q3) - L_tib*Lc_fem*M_fem*dq5*sin(q3) - L_tib*Lc_tib*M_tib*dq2*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq4*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq5*sin(q1 - q2 + q3 - q4);
       dq1*(L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4)) + dq5*(L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4)) + L_tib*Lc_tib*M_tib*dq3*sin(q1 - q2 + q3 - q4),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                L_fem*Lc_tib*M_tib*sin(q4)*(dq2 + dq5),                                                                                                                                                                                                                                L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4)*(dq1 + dq3 + dq5),                                                                                                        0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Lc_tib*M_tib*(L_tib*dq1*sin(q1 - q2 + q3 - q4) + L_tib*dq3*sin(q1 - q2 + q3 - q4) + L_tib*dq5*sin(q1 - q2 + q3 - q4) + L_fem*dq2*sin(q4) + L_fem*dq5*sin(q4) + L_fem*dq1*sin(q1 - q2 - q4) + L_fem*dq5*sin(q1 - q2 - q4));
       dq1*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*L_torso*M_torso*sin(q1) - L_fem*Lc_torso*M_torso*sin(q1) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3) + L_tib*L_torso*M_torso*sin(q1 + q3) - L_tib*Lc_torso*M_torso*sin(q1 + q3)) + dq5*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*L_torso*M_torso*sin(q1) - L_fem*Lc_torso*M_torso*sin(q1) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3) + L_tib*L_torso*M_torso*sin(q1 + q3) - L_tib*Lc_torso*M_torso*sin(q1 + q3)) + L_tib*dq3*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3) + L_torso*M_torso*sin(q1 + q3) - Lc_torso*M_torso*sin(q1 + q3) - 2*L_fem*M_fem*sin(q3) - L_fem*M_tib*sin(q3) - L_fem*M_torso*sin(q3) + Lc_fem*M_fem*sin(q3)), - dq2*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) - dq5*(L_fem^2*M_tib*sin(q1 - q2) + L_fem*Lc_tib*M_tib*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*sin(q1 - q2) + L_tib*Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*L_tib*M_tib*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*sin(q1 - q2 + q3)) - Lc_tib*M_tib*dq4*(L_tib*sin(q1 - q2 + q3 - q4) + L_fem*sin(q4) + L_fem*sin(q1 - q2 - q4)), L_tib*(dq1 + dq3 + dq5)*(Lc_tib*M_tib*sin(q1 - q2 + q3 - q4) + L_fem*M_tib*sin(q1 - q2 + q3) + Lc_fem*M_fem*sin(q1 - q2 + q3) + L_torso*M_torso*sin(q1 + q3) - Lc_torso*M_torso*sin(q1 + q3) - 2*L_fem*M_fem*sin(q3) - L_fem*M_tib*sin(q3) - L_fem*M_torso*sin(q3) + Lc_fem*M_fem*sin(q3)), -Lc_tib*M_tib*(L_tib*sin(q1 - q2 + q3 - q4) + L_fem*sin(q4) + L_fem*sin(q1 - q2 - q4))*(dq2 + dq4 + dq5), L_fem^2*M_tib*dq1*sin(q1 - q2) - L_fem^2*M_tib*dq2*sin(q1 - q2) + L_fem*L_tib*M_tib*dq1*sin(q1 - q2 + q3) - L_fem*L_tib*M_tib*dq2*sin(q1 - q2 + q3) + L_fem*L_tib*M_tib*dq3*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*dq1*sin(q1 - q2 + q3) - L_tib*Lc_fem*M_fem*dq2*sin(q1 - q2 + q3) + L_tib*Lc_fem*M_fem*dq3*sin(q1 - q2 + q3) + L_tib*L_torso*M_torso*dq1*sin(q1 + q3) + L_tib*L_torso*M_torso*dq3*sin(q1 + q3) - L_tib*Lc_torso*M_torso*dq1*sin(q1 + q3) - L_tib*Lc_torso*M_torso*dq3*sin(q1 + q3) - 2*L_fem*L_tib*M_fem*dq3*sin(q3) - L_fem*L_tib*M_tib*dq3*sin(q3) - L_fem*L_tib*M_torso*dq3*sin(q3) + L_fem*L_torso*M_torso*dq1*sin(q1) + L_tib*Lc_fem*M_fem*dq3*sin(q3) - L_fem*Lc_tib*M_tib*dq4*sin(q4) - L_fem*Lc_torso*M_torso*dq1*sin(q1) + L_fem*Lc_tib*M_tib*dq1*sin(q1 - q2 - q4) - L_fem*Lc_tib*M_tib*dq2*sin(q1 - q2 - q4) - L_fem*Lc_tib*M_tib*dq4*sin(q1 - q2 - q4) + L_fem*Lc_fem*M_fem*dq1*sin(q1 - q2) - L_fem*Lc_fem*M_fem*dq2*sin(q1 - q2) + L_tib*Lc_tib*M_tib*dq1*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq2*sin(q1 - q2 + q3 - q4) + L_tib*Lc_tib*M_tib*dq3*sin(q1 - q2 + q3 - q4) - L_tib*Lc_tib*M_tib*dq4*sin(q1 - q2 + q3 - q4)];
 
B=eye(5,4);
%%
Q =[q1 ;q2 ;q3 ;q4 ;q5];
DQ=[dq1;dq2;dq3;dq4;dq5];
c=[-1 0 -1/2 0 -1];
H0=eye(4,5);
Theta=c*Q;
[Hd,DHd_s,D2Hd_s]= BezierFunction(Theta,Alfa,Theta_plus,Theta_minus);

DH_theta=DHd_s/(Theta_minus-Theta_plus);
DH_q=DH_theta*c;
Lfg=(H0-DH_q)*(DD\B);
L2f=[D2Hd_s*c*DQ*c/(Theta_minus-Theta_plus)^2 DH_q  ]* [DQ ;DD^(-1)*(-CC*DQ-GG)] ;

y=H0*Q-Hd;
Dy_t=H0*DQ-DH_q*DQ;

v=-Kp*y-Kd*Dy_t;
u=Lfg\(v-L2f)*1;

D2Q=DD^(-1)*(B*u-CC*DQ-GG);

Dx=[DQ;D2Q];

end